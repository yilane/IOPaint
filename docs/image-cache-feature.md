# 图片缓存功能实现

## 功能说明

该功能实现了图片的本地缓存，当用户刷新页面后，如果有缓存的图片数据，会自动跳转到编辑界面，避免重复上传图片。

## 实现特点

1. **自动缓存**：当用户上传图片时，自动将图片保存到浏览器的 localStorage
2. **智能加载**：页面刷新时自动检测缓存，如果有缓存数据则直接加载
3. **缓存管理**：提供清除缓存按钮，用户可以手动清理缓存
4. **缓存过期**：缓存有效期为24小时，过期自动清理
5. **加载指示**：加载缓存时显示加载动画

## 核心功能文件

### 1. 缓存工具函数 (`src/lib/utils.ts`)

- `saveImageToCache(file: File)` - 保存图片到缓存
- `loadImageFromCache()` - 从缓存加载图片
- `clearImageCache()` - 清除图片缓存
- `hasCachedImage()` - 检查是否有缓存图片
- `updateCachedImageSize(width, height)` - 更新缓存图片尺寸信息

### 2. 状态管理 (`src/lib/states.ts`)

新增状态：
- `hasCachedData: boolean` - 是否有缓存数据
- `isLoadingCache: boolean` - 是否正在加载缓存

新增方法：
- `loadCachedImage()` - 加载缓存图片的Action
- `clearCache()` - 清除缓存的Action
- `setHasCachedData(value)` - 设置缓存状态的Action

### 3. 主应用组件 (`src/App.tsx`)

- 页面启动时自动检查缓存
- 如果检测到缓存图片，自动加载

### 4. 界面组件

#### 主布局 (`src/components/layout/MainLayout.tsx`)
- 加载缓存时显示加载动画

#### 顶部导航 (`src/components/layout/TopNavigation.tsx`)
- 添加清除缓存按钮（仅在有缓存时显示）

## 用户体验流程

1. **首次使用**：
   - 用户上传图片 → 图片自动保存到缓存 → 进入编辑界面

2. **页面刷新**：
   - 检测到缓存 → 显示加载动画 → 自动加载缓存图片 → 直接进入编辑界面
   - 无缓存 → 显示欢迎页面

3. **缓存管理**：
   - 用户可点击顶部的"清除缓存"按钮手动清理
   - 缓存24小时后自动过期

## 技术实现细节

### 缓存存储
- 使用浏览器的 `localStorage` 存储图片数据
- 图片转换为 base64 格式存储
- 包含图片信息（文件名、类型、尺寸、时间戳）

### 缓存键值
- `iopaint_cached_image` - 存储图片数据
- `iopaint_cached_image_info` - 存储图片信息

### 自动过期机制
- 缓存有效期：24小时
- 每次读取时检查时间戳
- 过期自动清理缓存数据

## 优化考虑

1. **性能优化**：大图片的base64转换可能影响性能，但考虑到用户体验的提升，这是可接受的
2. **存储限制**：localStorage有存储大小限制（通常5-10MB），超大图片可能无法缓存
3. **内存管理**：图片加载后及时释放不必要的内存引用
4. **错误处理**：完善的错误处理确保缓存失败不影响正常功能

## 未来扩展

1. **IndexedDB支持**：对于更大的图片，可考虑使用IndexedDB
2. **多图片缓存**：支持缓存多张图片的历史记录
3. **缓存压缩**：实现图片压缩以节省存储空间
4. **云端同步**：结合用户账户实现跨设备缓存同步 